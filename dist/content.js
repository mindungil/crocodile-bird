chrome.runtime.onMessage.addListener((e,n,t)=>{if(e.type==="TOGGLE_BIRD_OFF"){window.crocodileBirdActive=!1,s(),console.log("악어새 기능 중단"),t({ok:!0});return}else e.type==="SET_STEP"&&(window.crocodileBirdStep=e.step,console.log(`${e.step} 단계로 설정`));if(m()){console.log("이 페이지는 안전한 페이지 입니다."),t({ok:!0});return}return window.crocodileBirdStep==null&&(window.crocodileBirdStep=2),console.log(`악어새 봇이 ${window.crocodileBirdStep}단계로 돌아가는 중 입니다....`),window.crocodileBirdActive=!0,chrome.storage.local.get("step",i=>{window.crocodileBirdStep=i.step||1,a(),t({ok:!0})}),!0});async function a(){var r;console.log("[Content] content.js loaded");const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT),n=[];for(window.crocodileBirdActive=window.crocodileBirdActive||!1,window.crocodileBirdStep=window.crocodileBirdStep||3;e.nextNode();){const o=e.currentNode,l=(r=o.parentNode)==null?void 0:r.nodeName;["SCRIPT","STYLE","TEMPLATE","NOSCRIPT"].includes(l)||o.nodeValue.trim()&&n.push(o)}console.log(`추출 된 텍스트 배열: ${n.map(o=>o.nodeValue)}`),console.log("오버레이가 시작됩니다."),u();function t(o,l){return console.log("sendCleanRequest 함수 호출"),new Promise(d=>{chrome.runtime.sendMessage({type:"crocodile-bird-clean",text:o,num:l},c=>{d(c==null?void 0:c.cleaned)})})}async function i(o){const l=window.crocodileBirdStep;for(const d of o){const c=await t(d.nodeValue,l);c?(d.nodeValue=c,console.log("순화된 노드:",d.nodeValue)):console.log("node가 비어있거나 API 응답 없음")}s(),console.log(`총 ${o.length}건의 순화 완료`)}await i(n)}function u(){console.log("오버레이가 화면에 나타납니다.");const e=document.createElement("div");e.id="crocodile-bird-overlay";const n=document.createElement("img");n.style.width="32px",n.style.height="32px",n.style.marginRight="8px";const t=[chrome.runtime.getURL("icons/0.png"),chrome.runtime.getURL("icons/1.png"),chrome.runtime.getURL("icons/2.png"),chrome.runtime.getURL("icons/3.png"),chrome.runtime.getURL("icons/4.png"),chrome.runtime.getURL("icons/5.png"),chrome.runtime.getURL("icons/6.png"),chrome.runtime.getURL("icons/7.png")];let i=0;const r=document.createElement("span");r.textContent="악어새가 페이지를 검사하는 중입니다",Object.assign(e.style,{position:"fixed",top:"10px",right:"10px",background:"#000",color:"#fff",padding:"10px 14px",borderRadius:"8px",display:"flex",alignItems:"center",zIndex:2147483647});const o=setInterval(()=>{n.src=t[i],i=(i+1)%t.length},400);e.dataset.intervalId=o,e.appendChild(n),e.appendChild(r),document.body.appendChild(e)}function s(){console.log("오버레이가 화면에서 제거되는 중 입니다.");const e=document.getElementById("crocodile-bird-overlay");e&&(parseInt(e.dataset.intervalId),clearInterval(e.dataset.intervalId),e.remove())}function m(){const e=location.hostname,n=location.pathname,t=["go.kr","korea.kr","gouv.fr","gov.uk","who.int","un.org","openai.com","chat.openai.com"],i=["/policy","/static","/notice","/faq","/help","/support"],r=t.some(c=>e.endsWith(c)),o=i.some(c=>n.includes(c)),l=!!document.querySelector("textarea, input, form"),d=!!document.querySelector('[class*="comment"], [class*="reply"], [id*="user"]');return!!(r||o||!l&&!d)}
