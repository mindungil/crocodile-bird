chrome.runtime.onMessage.addListener((e,o,c)=>{if(e.type==="TOGGLE_BIRD_OFF"){window.crocodileBirdActive=!1,h(),console.log("악어새 기능 중단"),c({ok:!0});return}else e.type==="SET_STEP"&&(window.crocodileBirdStep=e.step,console.log(`${e.step} 단계로 설정`));if(y()){console.log("이 페이지는 안전한 페이지 입니다."),c({ok:!0});return}return window.crocodileBirdStep==null&&(window.crocodileBirdStep=2),console.log(`악어새 봇이 ${window.crocodileBirdStep}단계로 돌아가는 중 입니다....`),window.crocodileBirdActive=!0,chrome.storage.local.get("step",n=>{window.crocodileBirdStep=n.step||1,w(),c({ok:!0})}),!0});async function w(){var p;console.log("[Content] content.js loaded");const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT),o=[];for(window.crocodileBirdActive=window.crocodileBirdActive||!1,window.crocodileBirdStep=window.crocodileBirdStep||3;e.nextNode();){const t=e.currentNode,i=(p=t.parentNode)==null?void 0:p.nodeName;["SCRIPT","STYLE","TEMPLATE","NOSCRIPT","NAV","FIGCAPTION","HEADER","FOOTER","FORM","INPUT","BUTTON","SELECT","LABEL"].includes(i)||!t.nodeValue.trim()||o.push(t)}console.log("오버레이가 시작됩니다."),f();const c=await n(o);await a(o,c);function n(t){return t.map((i,r)=>`[NODE_${r}] ${i.nodeValue.trim()}`).join(`
`)}function s(t,i){const r=new Array(i).fill(""),l=/\[NODE_(\d+)\]\s*([\s\S]*?)(?=\[NODE_\d+\]|\s*$)/g;let u;for(;(u=l.exec(t))!==null;){const m=parseInt(u[1],10),g=u[2].trim();m<i&&(r[m]=g)}return r}async function d(t,i){return console.log("sendCleanRequest 함수 호출"),new Promise(r=>{chrome.runtime.sendMessage({type:"crocodile-bird-clean",text:t,num:i},l=>{r(l==null?void 0:l.cleaned)})})}async function a(t,i){const r=window.crocodileBirdStep,l=await d(i,r);if(!l){console.log("API 응답이 비어있음");return}const u=s(l,t.length);t.forEach((m,g)=>{m.nodeValue=u[g]||m.nodeValue}),h(),console.log(`총 ${t.length}건의 순화 완료`)}}function f(){console.log("오버레이가 화면에 나타납니다.");const e=document.createElement("div");e.id="crocodile-bird-overlay",Object.assign(e.style,{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",background:"#fff",display:"flex",justifyContent:"center",alignItems:"center",zIndex:2147483647});const o=document.createElement("div");Object.assign(o.style,{display:"flex",flexDirection:"column",alignItems:"center",gap:"16px",fontSize:"20px",color:"#000"});const c=document.createElement("span");c.textContent=`순화 작업 중...
 악어새가 열일하는 중입니다`;const n=document.createElement("img");n.style.width="65vw",n.style.height="45vh",n.style.display="block";const s=[chrome.runtime.getURL("icons/0.png"),chrome.runtime.getURL("icons/1.png"),chrome.runtime.getURL("icons/2.png"),chrome.runtime.getURL("icons/3.png"),chrome.runtime.getURL("icons/4.png"),chrome.runtime.getURL("icons/5.png"),chrome.runtime.getURL("icons/6.png"),chrome.runtime.getURL("icons/7.png")];let d=0;const a=setInterval(()=>{n.src=s[d],d=(d+1)%s.length},400);e.dataset.intervalId=a,o.appendChild(n),o.appendChild(c),e.appendChild(o),document.body.appendChild(e)}function h(){console.log("오버레이가 화면에서 제거되는 중 입니다.");const e=document.getElementById("crocodile-bird-overlay");e&&(parseInt(e.dataset.intervalId),clearInterval(e.dataset.intervalId),e.remove())}function y(){const e=location.hostname,o=location.pathname,c=["go.kr","korea.kr","gouv.fr","gov.uk","who.int","un.org","openai.com","chat.openai.com"],n=["/policy","/static","/notice","/faq","/help","/support"],s=c.some(t=>e.endsWith(t)),d=n.some(t=>o.includes(t)),a=!!document.querySelector("textarea, input, form"),p=!!document.querySelector('[class*="comment"], [class*="reply"], [id*="user"]');return!!(s||d||!a&&!p)}
