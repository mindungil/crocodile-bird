chrome.runtime.onMessage.addListener((e,t,i)=>{if(e.type==="TOGGLE_BIRD_OFF"){window.crocodileBirdActive=!1,h(),console.log("악어새 기능 중단"),i({ok:!0});return}else e.type==="SET_STEP"&&(window.crocodileBirdStep=e.step,console.log(`${e.step} 단계로 설정`));if(y()){console.log("이 페이지는 안전한 페이지 입니다."),i({ok:!0});return}return window.crocodileBirdStep==null&&(window.crocodileBirdStep=2),console.log(`악어새 봇이 ${window.crocodileBirdStep}단계로 돌아가는 중 입니다....`),window.crocodileBirdActive=!0,chrome.storage.local.get("step",n=>{window.crocodileBirdStep=n.step||1,w(),i({ok:!0})}),!0});async function w(){var r;console.log("[Content] content.js loaded");const e=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT),t=[];for(window.crocodileBirdActive=window.crocodileBirdActive||!1,window.crocodileBirdStep=window.crocodileBirdStep||3;e.nextNode();){const o=e.currentNode,c=(r=o.parentNode)==null?void 0:r.nodeName;["SCRIPT","STYLE","TEMPLATE","NOSCRIPT","NAV","FIGCAPTION","HEADER","FOOTER","FORM","INPUT","BUTTON","SELECT","LABEL","OBJECT","PARAM"].includes(c)||!o.nodeValue||!o.nodeValue.trim()||t.push(o)}console.log("오버레이가 시작됩니다."),f();const i=await n(t);await s(t,i);function n(o){return o.map((c,l)=>`[NODE_${l}] ${c.nodeValue.trim()}`).join(`
`)}function d(o,c){const l=new Array(c).fill(""),a=/\[NODE_(\d+)\]\s*([\s\S]*?)(?=\[NODE_\d+\]|\s*$)/g;let u;for(;(u=a.exec(o))!==null;){const g=parseInt(u[1],10),p=u[2].trim();g<c&&(l[g]=p)}return l}async function m(o,c){return console.log("sendCleanRequest 함수 호출"),new Promise(l=>{chrome.runtime.sendMessage({type:"crocodile-bird-clean",text:o,num:c},a=>{l(a==null?void 0:a.cleaned)})})}async function s(o,c){const l=window.crocodileBirdStep,a=await m(c,l);if(!a){console.log("API 응답이 비어있음");return}const u=d(a,o.length);o.forEach((g,p)=>{g.nodeValue=u[p]||g.nodeValue}),h(),console.log(`총 ${o.length}건의 순화 완료`)}}function f(){console.log("오버레이가 화면에 나타납니다.");const e=document.createElement("div");e.id="crocodile-bird-overlay",Object.assign(e.style,{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",background:"#fff",display:"flex",justifyContent:"center",alignItems:"center",zIndex:2147483647});const t=document.createElement("div");Object.assign(t.style,{display:"flex",flexDirection:"column",alignItems:"center",gap:"16px",fontSize:"20px",color:"#000"});let i=document.createElement("span");const n=document.createElement("img");n.style.width="65vw",n.style.height="45vh",n.style.display="block";const d=[chrome.runtime.getURL("icons/0.png"),chrome.runtime.getURL("icons/1.png"),chrome.runtime.getURL("icons/2.png"),chrome.runtime.getURL("icons/3.png"),chrome.runtime.getURL("icons/4.png"),chrome.runtime.getURL("icons/5.png"),chrome.runtime.getURL("icons/6.png"),chrome.runtime.getURL("icons/7.png")],m=["옛날, 나일강 근처의 밀림에는 무서운 악어 한 마리가 살고 있었습니다.","이 악어는 육지와 강을 오가며 사냥을 즐겼지만, 식사 후엔 입 안에 고기 찌꺼기와 이물질이 끼어 항상 불편했습니다.","어느 날, 작은 새 한 마리가 악어가 입을 벌린 채 햇볕을 쬐고 있는 것을 보고 다가왔습니다.","새는 용감하게 악어의 입속으로 들어가 고기 찌꺼기들을 쪼아 먹었습니다.","악어는 새를 해치지 않고 오히려 가만히 있었죠.","그날 이후로, 이 새는 악어의 이빨을 청소해주고, 악어는 새가 안전하게 입 안에서 먹이를 찾을 수 있도록 도와주었습니다.","둘은 서로에게 이득이 되는 관계, 즉 ‘공생 관계’를 맺게 되었습니다.","따라서 사람들은 이 새를 ‘악어새’라고 부르게 되었습니다.","오늘날까지도 “악어와 악어새처럼 서로 돕는 관계”는 협력의 상징으로 종종 비유됩니다."];let s=0,r=0;setInterval(()=>{n.src=d[s],s=(s+1)%d.length},400),setInterval(()=>{i.textContent=m[r],r=(r+1)%d.length},2500),e.dataset.intervalId=intervalIdImagel,t.appendChild(n),t.appendChild(i),e.appendChild(t),document.body.appendChild(e)}function h(){console.log("오버레이가 화면에서 제거되는 중 입니다.");const e=document.getElementById("crocodile-bird-overlay");e&&(parseInt(e.dataset.intervalId),clearInterval(e.dataset.intervalId),e.remove())}function y(){const e=location.hostname,t=location.pathname,i=["go.kr","korea.kr",".ac.kr","gouv.fr",".or.kr","gov.uk",".re.kr","who.int","un.org","openai.com","chat.openai.com","github.com","chrome://","notion","wikipedia.org","wikimedia.org","archive.org","ietf.org","mdn.mozilla.org","developer.mozilla.org","stackoverflow.com","readthedocs.io","npmjs.com","pypi.org","docs.google.com","drive.google.com","mail.google.com","outlook.live.com","outlook.office.com","mail.naver.com","mail.daum.net","mail.yahoo.com","proton.me","icloud.com"],n=["/policy","/static","/notice","/faq","/help","/support","/terms","/privacy","/about","/legal","/copyright","/docs","/document","/manual","/guide","/getting-started","/license","/disclaimer","/robots.txt","/sitemap"],d=i.some(o=>e.endsWith(o)),m=n.some(o=>t.includes(o)),s=!!document.querySelector("textarea, input, form"),r=!!document.querySelector('[class*="comment"], [class*="reply"], [id*="user"]');return!!(d||m||!s&&!r)}
